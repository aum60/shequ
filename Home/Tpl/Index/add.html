<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>发表文章-极趣</title>
<link rel="stylesheet" type="text/css" href="http://img.news18a.com/community/css/index.css">
</head>
<body class="ina_f5f5f5">
<{include file="../Public/head.html"}>

<link rel="stylesheet" type="text/css" href="__PUBLIC__/css/uploadify.css">
<script type="text/javascript" src="__PUBLIC__/js/jquery.uploadify.js"></script>
<link rel="stylesheet" href="__PUBLIC__/css/jquery.Jcrop.css" type="text/css" />
<script src="__PUBLIC__/js/jquery.Jcrop.js"></script>
<!--<script type="text/javascript" src="__PUBLIC__/xheditor/xheditor-1.2.1.min.js"></script>
<script type="text/javascript" src="__PUBLIC__/xheditor/xheditor_lang/zh-cn.js"></script>-->
<script type="text/javascript" charset="utf-8" src="__PUBLIC__/ueditor/ueditor.config.js"></script>
<script type="text/javascript" charset="utf-8" src="__PUBLIC__/ueditor/ueditor.all.min.js"> </script>
<script type="text/javascript" charset="utf-8" src="__PUBLIC__/ueditor/lang/zh-cn/zh-cn.js"></script>
<div class="ina_silde">
    <div class="ina_post" style="margin-top: 10px;">
        <div class="ina_post_bt"><h3>发表文章</h3></div>
        <div class="ina_postnr">
            <ul>
                <li>
                    <label>个性标题<b>*</b></label>
                    <input type="text" placeholder="在这里输入文章标题(⊙o⊙)…" id="ina_gxbt">
                    <p>还可以输入<b>18</b>个字</p>
                </li>

                <li>

                    <label class="ina_file_left" >上传封面<b>*</b></label>
                    <div class="ina_file ina_file_270" style="width: 370px; height: 185px;">
                        <div id="pic_show_2">
                            <p><i class="ina_icon"></i></p>
                            <p><span>上传图片</span></p>
                            <p style=" font-size: 12px;">想让内容吸引更多人浏览，选择一张优质照片作为展示封面图吧。头图上传限制最小尺寸为600*300PX，文件大小10MB以下，JPG格式。</p>
                        </div>
                        <input id="file_upload_1" type="file">
                    </div>
                    <span style="padding:10px; float: left; display: none;" id="error_show">图片不符合要求请重试</span>
                </li>

                 <li id="cut_pic_1">
                    <div id="cut_pic_1_2" style="width: 600px">
                        <img id="cropbox_1" src="" />
                    </div>
                    <!--<input type="button" id="cut_pic_button_1" value="剪裁" />-->
                    <a href="javascript:;;" id="clear_cut_pic_button_1" class="ina_save_1" style=" border:1px solid #999; color: #999;border-radius: 12px;line-height: 30px; margin-top:10px; float:left;padding:5px 10px;">取消</a>
                    &nbsp; &nbsp;
                    <a href="javascript:;;" id="cut_pic_button_1" style="background: #ff5a60 repeat scroll 0 0;border-radius: 12px;color: #fff;line-height: 30px; margin:10px; float:left;padding:5px 10px;">剪裁</a>
                     <!--<input type="checkbox" id="check_pic" value="1" />添加水印-->
                    <input type="hidden" id="x_1" name="x" />
                    <input type="hidden" id="y_1" name="y" /> 
                    <input type="hidden" id="w_1" name="w" /> 
                    <input type="hidden" id="h_1" name="h" />
                     <input type="hidden" id="realW" name="realW"/>
                     <input type="hidden" id="realH" name="realH"/>
                    <input type="hidden" id="showpicval_1" />
                    <input type="hidden" id="pic_times" />
                    <input type="hidden" id="is_cuts" value="" />

                </li>

                <li>
                    <label>发布正文<b>*</b></label>
                    <label style="padding-left: 100px;">添加水印<b>*</b></label>
                    <label><input type="checkbox" name="water" id="water" style="width: 100px;"/></label>
                    <label style="padding-left: 10px;width: 300px;"><b>*如需添加水印，请先勾选该功能再上传图片</b></label>
                    <!--<textarea id="c_content" style="width:98%;" rows="40" class="xheditor-simple" name="content" ></textarea>-->
                    
                </li>
                <li><script id="editor" type="text/plain" style="width:98%;height:500px;"></script></li>
                <li>
                    <label>&nbsp;</label>
                    <div class="ina_btn"><a href="javascript:;;" id="ina_save" data="1" class="ina_save"><i class="ina_icon"></i>保存</a><a href="javascript:;;" id="ina_fabu" data="1" class="ina_fabu"><i class="ina_icon"></i>发布</a></div>
                </li>
            </ul>
        </div>
    </div>
    <div style="clear:both;"></div>
</div>
<div class="ina_password_tk">
    <div class="ina_password_bt"><h3 class="ts_title" data=""></h3><a href="javascript:;" class="ina_icon"></a></div>
    <div class="ina_passwordnr">
        <p><i class="ina_icon"></i></p>
        <p class="ts_content"></p>
    </div>
</div>
<div class="ina_zhezhao"></div>
<style type="text/css">
    .button_style{ background: none; border:0;}
    .button_style:hover{ background: none;}
    .uploadify-button:hover{ background: none;}
    .uploadify object{ left: 0; top: 0;}
    #cut_pic{display: none; height: auto;}
    #cut_pic_1{display: none; height: auto;}
    #cut_pic input{ width: 100px;border: 1px solid #ccc; color: #292929; width: 100px; cursor: pointer}
    #cut_pic_1 input{ width: 100px; border: 1px solid #ccc; color: #292929; width: 100px; cursor: pointer}
    #cut_pic_1 img{ max-width: 900px;}
    /*#pic_show_2 img{ max-width: 300px;}*/
</style>
<script>

var ue = UE.getEditor('editor');
UE.Editor.prototype._bkGetActionUrl = UE.Editor.prototype.getActionUrl;  
    UE.Editor.prototype.getActionUrl = function(action) {  
        if (action == 'uploadimage' || action == 'uploadfile') {  
            var id = $('#carInfoId').val();
            var water = '';
            if($('#water').is(':checked')) {
                 water = '?is_water=1'
            }
            return '__URL__/doupload' + water;
        } else {  
            return this._bkGetActionUrl.call(this, action);  
        }  
    };  
/*提示框*/
$(".ina_sure").click(function(){
    $(".ina_forgetpassword").find("ul li span").hide();
    var password1=$("#ina_password1").val(),password2=$("#ina_password2").val();
    if(password1!=password2){
        $(".ina_forgetpassword").find("ul li span").show();
        return false;
    }
    else{
        $(".ina_zhezhao,.ina_password_tk").show();
    }
})
$(".ina_zhezhao,.ina_password_tk .ina_password_bt a").click(function(){
    $(".ina_zhezhao,.ina_password_tk").hide();
    if($('.ts_title').attr('data')=='1'){
         window.location.href='__APP__/Ucenter/mymess';
    }else{
        window.location.href='__APP__/Ucenter/mymess';
    }
    
});
/*提示框end*/
if($(".ina_post .ina_postnr ul li .ina_change a").length>0){
    $(".ina_post .ina_postnr ul li .ina_change a").click(function(){
        $(this).addClass('ina_cur').siblings().removeClass('ina_cur');
    })
}
var element = document.getElementById("ina_gxbt");
if("\v"=="v") {
     if(/msie/i.test(navigator.userAgent)){element.onpropertychange = myfun;}
}else{
     element.addEventListener("input",myfun,false);
}
function myfun(){
    var val=element.value;
$("#ina_gxbt").parents("li").find("p b").html(18-val.length);
}


//裁剪和上传
$(function(){

    $('#file_upload_1').uploadify({
        'formData': {
            'timestamp': '<{$time}>',
            'token': '<{$token}>',
            'sessionid': '<{$session_id}>',
            'sizeproportion':2
        },
        'swf': '__PUBLIC__/js/uploadify.swf',
        'auto': true, //是否自动上传
        'uploader': '__URL__/add_uploadpic/',
        'fileTypeExts': '*.jpg;*.gif;*.jpeg;*.png',
        'buttonText': '',
        'removeTimeout': 0,
        'height'        : 185,
        'width'        : 370,
        'buttonClass': "button_style",
        'onUploadStart':function(){
            $("#error_show").hide();
           $("#cut_pic_1").slideDown(500);
           $("#cut_pic_1_2").html("<img id='cropbox' src='http://img.news18a.com/community/image/lazyload_324.jpg' />");
        },
        'onInit': function () {
           $("#file_upload-queue").hide();
        },
        'onUploadSuccess': function (file, data, respone) {
            $("#cut_pic_1_2").empty();
            if(data==99){
                ina_tkclose("提示信息","上传图片不能小于600*300")
                return;
            }
            if(data==33){
                ina_tkclose("提示信息","上传图片比例不合适")
                return;
            }

            data_str = eval("(" + data + ")");
            $("#cut_pic_1_2").html("<img id='cropbox_1' src='<{$ftp_img_path}>" + data_str.pic + "' />");
            $("#pic_times").val(data_str.times);
            //$("#cropbox_1").attr('src','<{$ftp_img_path}>' + data);
            $("#showpicval_1").val(data_str.pic);
            //$("#cut_pic_1").slideDown(500);
            //调用裁剪插件
            if(data_str.times==1){
                str_width = 600;
                str_height = 300;
            }else if(data_str.times==2){
                str_width = 600;
                str_height = 300;
            }else if(data_str.times==3){
                str_width = 600;
                str_height = 300;
            }else if(data_str.times==4){
                str_width = 600;
                str_height = 300;
            }
            $('#cropbox_1').Jcrop({
                aspectRatio: 2 / 1,
                onSelect: updateCoords_1,
                allowResize:false,
                minSize:[str_width,str_height],
                setSelect:[0,0,str_width,str_height],
                onRelease:function(){
                    return;
                }
            });
        },
        'onUploadError':function(file, errorCode, errorMsg){
//            switch (errorCode) {
//                case -100:
//                    alert("上传的文件数量已经超出系统限制的" + $('#file_upload').uploadify('settings', 'queueSizeLimit') + "个文件！");
//                    break;
//                case -110:
//                    alert("文件 [" + file.name + "] 大小超出系统限制的" + $('#file_upload').uploadify('settings', 'fileSizeLimit') + "大小！");
//                    break;
//                case -120:
//                    alert("文件 [" + file.name + "] 大小异常！");
//                    break;
//                case -130:
//                    alert("文件 [" + file.name + "] 类型不正确！");
//                    break;
//            }
            //alert(errorCode + '--' +errorMsg);
            $("#error_show").show();
            $("#cut_pic_1_2").empty();
            $("#showpicval_1").val('');
            $("#cut_pic_1").slideUp(500);
        }
    });

    //取消裁剪
    $("#clear_cut_pic_button_1").click(function(){
            $("#error_show").hide();
            $("#cut_pic_1_2").empty();
            $("#showpicval_1").val('');
            $("#cut_pic_1").slideUp(500);
        
    });
    //裁剪
    $("#cut_pic_button_1").click(function(){
        if (parseInt($('#w_1').val())){
            var pic_times = $("#pic_times").val();
            var pn =  $('#showpicval_1').val();
            var x = $('#x_1').val();
            var y = $('#y_1').val();
            var w = $('#w_1').val();
            var h = $('#h_1').val();
            $.post("__APP__/Index/cut_pic_size",
                    {'pic_times':pic_times,'pn':pn,'x':x,'y':y,'w':w,'h':h,'type':2},
                    function(res){
                if(res==1000){
                    ina_tkclose("提示信息","裁剪区域过小请重新选择，三秒后将自动关闭…")
                }else{
                    $("#cut_pic_1").slideUp(500);
                    $("#is_cuts").val(1);
                    $("#pic_show_2").html("<img src='<{$ftp_img_path}>" + res + "' width='270' height='180'>")
                    $('#showpicval_1').val(res);
                }

            });
        }else{
            ina_tkclose("提示信息","请选择一个裁剪区域，三秒后将自动关闭…")
        }

    });

    function updateCoords_1(c){
        $('#x_1').val(c.x);
        $('#y_1').val(c.y);
        $('#w_1').val(c.w);
        $('#h_1').val(c.h);

    }
    //发帖
    $("#ina_fabu").click(function(){
        var ina_gxbt =$("#ina_gxbt").val();
        //var column = $(".ina_change a.ina_cur").attr("data");
        var showpicval  = $("#showpicval").val();
        var showpicval_1 = $("#showpicval_1").val();
        var c_content = ue.getContent();
        
        if(ina_gxbt==''){
            ina_tkclose("提示信息","请填写标题，三秒后将自动关闭…")
            return;
        }
        if(ina_gxbt.length>18){
            ina_tkclose("提示信息","超出标题长度请修改，三秒后将自动关闭…")
            return;
        }
        if(showpicval_1==''){
            ina_tkclose("提示信息","请上传封面图，三秒后将自动关闭…")
            return;
        }
         if($("#is_cuts").val()==''){
            ina_tkclose("提示信息","请裁剪封面图，三秒后将自动关闭…")
            return;
        }
        if(c_content==''){
            ina_tkclose("提示信息","请输入帖子内容，三秒后将自动关闭…")
            return;
        }
        var fabu_data = $(this).attr('data');
        $(this).attr('data','2').html('<i class="ina_icon"></i>发布中');
        send_this = $(this);
        if(fabu_data==1){
            $.post("__APP__/Index/add_posts",{'ina_gxbt':ina_gxbt,'showpicval':showpicval,'showpicval_1':showpicval_1,'c_content':c_content,'types':2},function(res){
                if(res==100){
                    ina_tkclose("提示信息","您已被禁言，三秒后将自动关闭…")
                }
                if(res==101){
                    ina_tkclose("提示信息","请先完善信息，三秒后将自动跳转…",function(){
                       window.location.href="__APP__/Ucenter/euserinfo";
                    });
                   return;
                }
                if(res==1){
//                        ina_tkclose("提示信息","发帖成功，三秒后将自动跳转…",function(){
//                            window.location.href="__APP__/Ucenter";
//                        });
                        window.location.href="__APP__/Ucenter/mymess/flag/no";
                }
                if(res==2){
                    ina_tkclose("提示信息","帖子信息不完整，三秒后将自动关闭…")
                    send_this.attr('data','1').html('<i class="ina_icon"></i>发布');

                }
                if(res==3){
                    ina_tkclose("提示信息","发帖失败请重试，三秒后将自动关闭…")
                    send_this.attr('data','1').html('<i class="ina_icon"></i>发布');
                }

            });
        }
    });

    //保存至草稿箱
    $("#ina_save").click(function(){
        var ina_gxbt = $("#ina_gxbt").val();
        if($('#water').is(':checked')) {
           var water = 1;
        }else{
            var water = 0;
        }
        //var column = $(".ina_change a.ina_cur").attr("data");
        var showpicval  = $("#showpicval").val();
        var showpicval_1 = $("#showpicval_1").val();
        var c_content = ue.getContent();
        if(ina_gxbt==''){
            ina_tkclose("提示信息","请填写标题，三秒后将自动关闭…")
            return;
        }
        if(ina_gxbt.length>18){
            ina_tkclose("提示信息","超出标题长度请修改，三秒后将自动关闭…")
            return;
        }
        //为剪裁不好存封面图
        if($("#is_cuts").val()==''){
            showpicval_1 = '';
        }
        var save_data = $(this).attr('data');
        $(this).attr('data','2').html('<i class="ina_icon"></i>保存中');
        save_this = $(this);
        if(save_data==1){  
            $.post("__APP__/Index/add_posts",{'ina_gxbt':ina_gxbt,'water':water,'showpicval':showpicval,'showpicval_1':showpicval_1,'c_content':c_content,'types':1},function(res){
                if(res==1){
//                    ina_tkclose("提示信息","草稿保存成功，三秒后将自动跳转…",function(){
//                        window.location.href="__APP__/Ucenter";
//                    });
                    window.location.href="__APP__/Ucenter/draft";
                }else{
                    save_this.attr('data','1').html('<i class="ina_icon"></i>保存');
                }

            }).error(function(){
                
            });
        }
    });
});

</script>
<{include file="../Public/foot.html"}>
</body>
</html>